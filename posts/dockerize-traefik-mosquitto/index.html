<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Dokerize mosquitto throw traefik" /><meta property="og:locale" content="en" /><meta name="description" content="Yes, it is possible to dockerize a Mosquitto MQTT broker with TLS (Transport Layer Security) using Traefik as a reverse proxy to handle TLS termination and certificate management (e.g., via Let’s Encrypt). This setup simplifies securing MQTT communication by offloading TLS handling to Traefik, allowing Mosquitto to operate on unencrypted ports internally while exposing secure endpoints externally. Below, I’ll explain the process in detail, including how certificates work in this context, why Traefik is useful, and provide a step-by-step guide with a sample configuration." /><meta property="og:description" content="Yes, it is possible to dockerize a Mosquitto MQTT broker with TLS (Transport Layer Security) using Traefik as a reverse proxy to handle TLS termination and certificate management (e.g., via Let’s Encrypt). This setup simplifies securing MQTT communication by offloading TLS handling to Traefik, allowing Mosquitto to operate on unencrypted ports internally while exposing secure endpoints externally. Below, I’ll explain the process in detail, including how certificates work in this context, why Traefik is useful, and provide a step-by-step guide with a sample configuration." /><link rel="canonical" href="https://gitjmc.github.io/posts/dockerize-traefik-mosquitto/" /><meta property="og:url" content="https://gitjmc.github.io/posts/dockerize-traefik-mosquitto/" /><meta property="og:site_name" content="JMC-memo" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2025-04-30T12:35:00-04:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Dokerize mosquitto throw traefik" /><meta name="twitter:site" content="@twitter_username" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2025-04-30T12:35:00-04:00","datePublished":"2025-04-30T12:35:00-04:00","description":"Yes, it is possible to dockerize a Mosquitto MQTT broker with TLS (Transport Layer Security) using Traefik as a reverse proxy to handle TLS termination and certificate management (e.g., via Let’s Encrypt). This setup simplifies securing MQTT communication by offloading TLS handling to Traefik, allowing Mosquitto to operate on unencrypted ports internally while exposing secure endpoints externally. Below, I’ll explain the process in detail, including how certificates work in this context, why Traefik is useful, and provide a step-by-step guide with a sample configuration.","headline":"Dokerize mosquitto throw traefik","mainEntityOfPage":{"@type":"WebPage","@id":"https://gitjmc.github.io/posts/dockerize-traefik-mosquitto/"},"url":"https://gitjmc.github.io/posts/dockerize-traefik-mosquitto/"}</script><title>Dokerize mosquitto throw traefik | JMC-memo</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="JMC-memo"><meta name="application-name" content="JMC-memo"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" https://gitjmc.github.io/assets/img/favicons/avatar.jpg " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">JMC-memo</a></div><div class="site-subtitle font-italic">À la demande de sisi</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/gitjmc" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/twitter_username" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['example','doamin.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Dokerize mosquitto throw traefik</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Dokerize mosquitto throw traefik</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/username">Jerbi Mohamed Chamseddine</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1746030900" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2025-04-30 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2243 words"> <em>12 min</em> read</span></div></div></div><div class="post-content"><p>Yes, it is possible to dockerize a <strong>Mosquitto MQTT broker</strong> with <strong>TLS</strong> (Transport Layer Security) using <strong>Traefik</strong> as a reverse proxy to handle TLS termination and certificate management (e.g., via Let’s Encrypt). This setup simplifies securing MQTT communication by offloading TLS handling to Traefik, allowing Mosquitto to operate on unencrypted ports internally while exposing secure endpoints externally. Below, I’ll explain the process in detail, including how certificates work in this context, why Traefik is useful, and provide a step-by-step guide with a sample configuration.</p><hr /><h2 id="why-use-traefik-with-mosquitto-for-tls"><span class="mr-2"><strong>Why Use Traefik with Mosquitto for TLS?</strong></span><a href="#why-use-traefik-with-mosquitto-for-tls" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Traefik is a modern reverse proxy that integrates well with Docker, automatically discovers services, and simplifies TLS certificate management using Let’s Encrypt. Using Traefik with Mosquitto offers several benefits:</p><ul><li><strong>Centralized TLS Management</strong>: Traefik handles TLS termination, so Mosquitto doesn’t need to manage certificates directly.<li><strong>Automatic Certificate Renewal</strong>: Traefik can obtain and renew Let’s Encrypt certificates, reducing maintenance overhead.<li><strong>Scalability</strong>: Traefik supports load balancing across multiple Mosquitto instances if needed.<li><strong>Simplified Configuration</strong>: Traefik’s dynamic configuration via Docker labels reduces the need for manual certificate setup in Mosquitto.<li><strong>WebSocket Support</strong>: Traefik can handle MQTT over WebSockets, useful for browser-based or IoT applications.</ul><p>In this setup:</p><ul><li><strong>Mosquitto</strong> runs in a Docker container, listening on unencrypted ports (e.g., 1883 for MQTT, 9001 for WebSockets).<li><strong>Traefik</strong> listens on secure ports (e.g., 8883 for MQTT, 443 for WebSockets), terminates TLS, and forwards traffic to Mosquitto’s unencrypted ports.<li><strong>Let’s Encrypt</strong> provides trusted certificates, eliminating the need for self-signed certificates (though self-signed certificates can be used for testing).</ul><hr /><h2 id="how-certificates-work-in-this-setup"><span class="mr-2"><strong>How Certificates Work in This Setup</strong></span><a href="#how-certificates-work-in-this-setup" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>To understand how certificates are managed with Traefik and Mosquitto, let’s revisit the certificate concepts from your previous question and apply them to this context:</p><h3 id="certificate-roles"><span class="mr-2"><strong>Certificate Roles</strong></span><a href="#certificate-roles" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ul><li><strong>CA Certificate (<code class="language-plaintext highlighter-rouge">cafile</code>)</strong>: In a traditional Mosquitto TLS setup, the client (e.g., ESP32) uses the CA certificate to verify the server’s certificate. With Traefik, the CA certificate is typically the Let’s Encrypt root or intermediate certificate, which is already trusted by most clients (e.g., browsers, MQTT libraries).<li><strong>Server Certificate (<code class="language-plaintext highlighter-rouge">certfile</code>)</strong>: Traefik presents a server certificate (obtained from Let’s Encrypt) to clients during the TLS handshake. Mosquitto doesn’t need a server certificate since Traefik handles TLS.<li><strong>Private Key (<code class="language-plaintext highlighter-rouge">keyfile</code>)</strong>: Traefik uses the private key associated with the Let’s Encrypt certificate for cryptographic operations. Mosquitto doesn’t need a private key in this setup.<li><strong>Client Certificates</strong> (optional): If mutual TLS is required, Mosquitto can be configured to verify client certificates, but this is less common with Traefik setups and requires additional configuration.</ul><h3 id="file-formats"><span class="mr-2"><strong>File Formats</strong></span><a href="#file-formats" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ul><li>Traefik stores Let’s Encrypt certificates in a JSON file (<code class="language-plaintext highlighter-rouge">acme.json</code>) in a mounted volume, not as separate <code class="language-plaintext highlighter-rouge">.pem</code>, <code class="language-plaintext highlighter-rouge">.crt</code>, or <code class="language-plaintext highlighter-rouge">.key</code> files.<li>Clients (e.g., ESP32) may need the Let’s Encrypt CA certificate (e.g., <code class="language-plaintext highlighter-rouge">ISRG Root X1</code>) in <code class="language-plaintext highlighter-rouge">.pem</code> format to verify Traefik’s certificate. This is often unnecessary for modern clients, as Let’s Encrypt’s CA is widely trusted.<li>If you use self-signed certificates for testing, you’ll need <code class="language-plaintext highlighter-rouge">.pem</code> or <code class="language-plaintext highlighter-rouge">.crt</code> files for the CA and server certificates, similar to a traditional Mosquitto setup.</ul><h3 id="tls-flow"><span class="mr-2"><strong>TLS Flow</strong></span><a href="#tls-flow" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ol><li>The client (e.g., ESP32) connects to Traefik on port 8883 (MQTT) or 443 (WebSocket).<li>Traefik presents its Let’s Encrypt certificate to the client.<li>The client verifies the certificate using the Let’s Encrypt CA (usually built into the client’s trust store).<li>Traefik decrypts the incoming traffic and forwards it to Mosquitto on an unencrypted port (e.g., 1883).<li>Mosquitto processes the MQTT messages and responds via Traefik, which re-encrypts the response.</ol><p>This approach simplifies Mosquitto’s configuration, as it doesn’t need to handle TLS directly, but it requires Traefik to be properly configured for TCP routing and TLS.</p><hr /><h2 id="challenges-and-considerations"><span class="mr-2"><strong>Challenges and Considerations</strong></span><a href="#challenges-and-considerations" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ul><li><strong>SNI Support</strong>: Traefik uses Server Name Indication (SNI) for routing, but many MQTT clients (e.g., <code class="language-plaintext highlighter-rouge">mosquitto_pub</code>) don’t support SNI. Traefik’s <code class="language-plaintext highlighter-rouge">HostSNI(</code>*<code class="language-plaintext highlighter-rouge">)</code> rule can bypass this for TCP services, but testing with such clients may require workarounds.<a href="https://community.traefik.io/t/mosquitto-mqtt-and-tls-without-client-hostsni/21912"></a><li><strong>Port Exposure</strong>: Mosquitto’s ports (1883, 9001) should not be exposed directly in Docker to ensure all traffic goes through Traefik. Use <code class="language-plaintext highlighter-rouge">expose</code> instead of <code class="language-plaintext highlighter-rouge">ports</code> in the Docker Compose file.<a href="https://gist.github.com/gimiki/628e2ca10f026975f00f34e4d1f4ff23?permalink_comment_id=3463714"></a><li><strong>WebSocket Support</strong>: If you need MQTT over WebSockets (e.g., for browser-based clients), Traefik must be configured to handle WebSocket traffic on port 443.<a href="https://medium.com/himinds/mqtt-broker-with-secure-websocket-using-traefik-docker-compose-and-lets-encrypt-2b8e32207555"></a><li><strong>Certificate Verification</strong>: Clients must trust the Let’s Encrypt CA. For self-signed certificates, you’ll need to provide the CA certificate to clients (e.g., ESP32).<a href="https://primalcortex.wordpress.com/2016/03/31/mqtt-mosquitto-broker-with-ssltls-transport-security/"></a><li><strong>Mutual TLS</strong>: If you require client certificate authentication, Mosquitto must handle it, as Traefik typically doesn’t verify client certificates for TCP services. This requires additional Mosquitto configuration.<a href="https://www.espboards.dev/blog/secure-mqtt-broker-docker-hass/"></a></ul><hr /><h2 id="step-by-step-guide-to-dockerize-mosquitto-with-tls-via-traefik"><span class="mr-2"><strong>Step-by-Step Guide to Dockerize Mosquitto with TLS via Traefik</strong></span><a href="#step-by-step-guide-to-dockerize-mosquitto-with-tls-via-traefik" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Below is a detailed guide to set up a Mosquitto MQTT broker with TLS using Traefik and Let’s Encrypt in a Docker environment. This setup assumes you have a publicly accessible domain (e.g., <code class="language-plaintext highlighter-rouge">mqtt.example.com</code>) for Let’s Encrypt.</p><h3 id="prerequisites"><span class="mr-2"><strong>Prerequisites</strong></span><a href="#prerequisites" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ul><li>Docker and Docker Compose installed.<li>A publicly accessible domain (e.g., <code class="language-plaintext highlighter-rouge">mqtt.example.com</code>) pointing to your server’s public IP.<li>Ports 80, 443, and 8883 open on your server for HTTP, HTTPS, and MQTT.<li>Basic understanding of Docker, Traefik, and Mosquitto.</ul><h3 id="1-create-directory-structure"><span class="mr-2"><strong>1. Create Directory Structure</strong></span><a href="#1-create-directory-structure" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>Create a project directory with the following structure:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre>mosquitto-traefik/
├── traefik/
│   ├── traefik.yml
│   └── acme.json
├── mosquitto/
│   ├── config/
│   │   ├── mosquitto.conf
│   │   └── passwd
│   ├── data/
│   └── log/
├── .env
└── docker-compose.yml
</pre></table></code></div></div><h3 id="2-configure-environment-variables"><span class="mr-2"><strong>2. Configure Environment Variables</strong></span><a href="#2-configure-environment-variables" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>Create a <code class="language-plaintext highlighter-rouge">.env</code> file to store configuration variables:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>MQTT_DOCKER_TAG=latest
TRAEFIK_DOCKER_TAG=latest
MQTT_LETSENCRYPT_EMAIL=your-email@example.com
MQTT_VIRTUAL_HOST=mqtt.example.com
</pre></table></code></div></div><ul><li><code class="language-plaintext highlighter-rouge">MQTT_VIRTUAL_HOST</code>: Your domain for the MQTT broker (e.g., <code class="language-plaintext highlighter-rouge">mqtt.example.com</code>).<li><code class="language-plaintext highlighter-rouge">MQTT_LETSENCRYPT_EMAIL</code>: Email for Let’s Encrypt notifications.</ul><h3 id="3-configure-traefik"><span class="mr-2"><strong>3. Configure Traefik</strong></span><a href="#3-configure-traefik" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>Create <code class="language-plaintext highlighter-rouge">traefik/traefik.yml</code> for Traefik’s static configuration:</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="na">entryPoints</span><span class="pi">:</span>
  <span class="na">web</span><span class="pi">:</span>
    <span class="na">address</span><span class="pi">:</span> <span class="s2">"</span><span class="s">:80"</span>
  <span class="na">websecure</span><span class="pi">:</span>
    <span class="na">address</span><span class="pi">:</span> <span class="s2">"</span><span class="s">:443"</span>
  <span class="na">mqtt</span><span class="pi">:</span>
    <span class="na">address</span><span class="pi">:</span> <span class="s2">"</span><span class="s">:8883"</span>

<span class="na">providers</span><span class="pi">:</span>
  <span class="na">docker</span><span class="pi">:</span>
    <span class="na">exposedByDefault</span><span class="pi">:</span> <span class="no">false</span>
    <span class="na">network</span><span class="pi">:</span> <span class="s">mqtt</span>

<span class="na">certificatesResolvers</span><span class="pi">:</span>
  <span class="na">letsencrypt</span><span class="pi">:</span>
    <span class="na">acme</span><span class="pi">:</span>
      <span class="na">email</span><span class="pi">:</span> <span class="s2">"</span><span class="s">${MQTT_LETSENCRYPT_EMAIL}"</span>
      <span class="na">storage</span><span class="pi">:</span> <span class="s">/letsencrypt/acme.json</span>
      <span class="na">tlsChallenge</span><span class="pi">:</span> <span class="no">true</span>

<span class="na">log</span><span class="pi">:</span>
  <span class="na">level</span><span class="pi">:</span> <span class="s">DEBUG</span>
</pre></table></code></div></div><ul><li>Defines entry points for HTTP (80), HTTPS (443), and MQTT (8883).<li>Configures Let’s Encrypt for automatic certificate generation.<li>Uses the <code class="language-plaintext highlighter-rouge">mqtt</code> Docker network for communication.</ul><p>Create an empty <code class="language-plaintext highlighter-rouge">traefik/acme.json</code> and set permissions:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nb">touch </span>traefik/acme.json
<span class="nb">chmod </span>600 traefik/acme.json
</pre></table></code></div></div><h3 id="4-configure-mosquitto"><span class="mr-2"><strong>4. Configure Mosquitto</strong></span><a href="#4-configure-mosquitto" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>Create <code class="language-plaintext highlighter-rouge">mosquitto/config/mosquitto.conf</code> for Mosquitto:</p><div class="language-conf highlighter-rouge"><div class="code-header"> <span data-label-text="Conf"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="n">persistence</span> <span class="n">true</span>
<span class="n">persistence_location</span> /<span class="n">mosquitto</span>/<span class="n">data</span>/
<span class="n">log_dest</span> <span class="n">file</span> /<span class="n">mosquitto</span>/<span class="n">log</span>/<span class="n">mosquitto</span>.<span class="n">log</span>

<span class="n">listener</span> <span class="m">1883</span>
<span class="n">protocol</span> <span class="n">mqtt</span>
<span class="n">allow_anonymous</span> <span class="n">false</span>
<span class="n">password_file</span> /<span class="n">mosquitto</span>/<span class="n">config</span>/<span class="n">passwd</span>

<span class="n">listener</span> <span class="m">9001</span>
<span class="n">protocol</span> <span class="n">websockets</span>
<span class="n">allow_anonymous</span> <span class="n">false</span>
<span class="n">password_file</span> /<span class="n">mosquitto</span>/<span class="n">config</span>/<span class="n">passwd</span>
</pre></table></code></div></div><ul><li>Listens on port 1883 for MQTT and 9001 for WebSockets.<li>Disables anonymous access and uses a password file for authentication.</ul><p>Create a password file for Mosquitto:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>docker run <span class="nt">-it</span> eclipse-mosquitto:<span class="k">${</span><span class="nv">MQTT_DOCKER_TAG</span><span class="k">}</span> mosquitto_passwd <span class="nt">-c</span> /mosquitto/config/passwd &lt;username&gt;
</pre></table></code></div></div><p>Copy the generated <code class="language-plaintext highlighter-rouge">passwd</code> file to <code class="language-plaintext highlighter-rouge">mosquitto/config/passwd</code>.</p><h3 id="5-create-docker-compose-file"><span class="mr-2"><strong>5. Create Docker Compose File</strong></span><a href="#5-create-docker-compose-file" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>Create <code class="language-plaintext highlighter-rouge">docker-compose.yml</code> to define Traefik and Mosquitto services:</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
</pre><td class="rouge-code"><pre><span class="na">version</span><span class="pi">:</span> <span class="s2">"</span><span class="s">3.8"</span>

<span class="na">services</span><span class="pi">:</span>
  <span class="na">traefik</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">traefik:${TRAEFIK_DOCKER_TAG}</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">traefik</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">80:80"</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">443:443"</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">8883:8883"</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">./traefik/traefik.yml:/etc/traefik/traefik.yml</span>
      <span class="pi">-</span> <span class="s">./traefik/acme.json:/letsencrypt/acme.json</span>
      <span class="pi">-</span> <span class="s">/var/run/docker.sock:/var/run/docker.sock</span>
    <span class="na">networks</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">mqtt</span>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">always</span>

  <span class="na">mosquitto</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">eclipse-mosquitto:${MQTT_DOCKER_TAG}</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">mosquitto</span>
    <span class="na">expose</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">1883"</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">9001"</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">./mosquitto/config:/mosquitto/config</span>
      <span class="pi">-</span> <span class="s">./mosquitto/data:/mosquitto/data</span>
      <span class="pi">-</span> <span class="s">./mosquitto/log:/mosquitto/log</span>
    <span class="na">networks</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">mqtt</span>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">always</span>
    <span class="na">labels</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">traefik.enable=true"</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">traefik.docker.network=mqtt"</span>
      <span class="c1"># MQTT TCP Service</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">traefik.tcp.routers.mqtt.rule=HostSNI(`*`)"</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">traefik.tcp.routers.mqtt.entrypoints=mqtt"</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">traefik.tcp.routers.mqtt.tls=true"</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">traefik.tcp.routers.mqtt.tls.certresolver=letsencrypt"</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">traefik.tcp.services.mqtt.loadbalancer.server.port=1883"</span>
      <span class="c1"># WebSocket Service</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">traefik.http.routers.mqtt-ws.rule=Host(`${MQTT_VIRTUAL_HOST}`)"</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">traefik.http.routers.mqtt-ws.entrypoints=websecure"</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">traefik.http.routers.mqtt-ws.tls=true"</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">traefik.http.routers.mqtt-ws.tls.certresolver=letsencrypt"</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">traefik.http.services.mqtt-ws.loadbalancer.server.port=9001"</span>

<span class="na">networks</span><span class="pi">:</span>
  <span class="na">mqtt</span><span class="pi">:</span>
    <span class="na">driver</span><span class="pi">:</span> <span class="s">bridge</span>
</pre></table></code></div></div><ul><li><strong>Traefik</strong>: Exposes ports 80, 443, and 8883, mounts configuration and certificate files, and listens for Docker events.<li><strong>Mosquitto</strong>: Exposes internal ports 1883 and 9001 (not bound to the host), mounts configuration and data volumes, and uses Traefik labels for routing.<li><strong>Labels</strong>:<ul><li><code class="language-plaintext highlighter-rouge">HostSNI(</code>*<code class="language-plaintext highlighter-rouge">)</code> for MQTT TCP routing (bypasses SNI issues).<li>TLS enabled with Let’s Encrypt (<code class="language-plaintext highlighter-rouge">tls=true</code>, <code class="language-plaintext highlighter-rouge">certresolver=letsencrypt</code>).<li>WebSocket routing uses the domain (<code class="language-plaintext highlighter-rouge">Host(${MQTT_VIRTUAL_HOST})</code>).</ul></ul><h3 id="6-start-the-services"><span class="mr-2"><strong>6. Start the Services</strong></span><a href="#6-start-the-services" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>Run the Docker Compose stack:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>docker-compose up <span class="nt">-d</span>
</pre></table></code></div></div><ul><li>Traefik will obtain a Let’s Encrypt certificate for <code class="language-plaintext highlighter-rouge">mqtt.example.com</code>.<li>Mosquitto will start and listen on 1883 (MQTT) and 9001 (WebSockets) internally.<li>Traefik will route external traffic from port 8883 (MQTT) to Mosquitto’s 1883 and from port 443 (WebSocket) to Mosquitto’s 9001.</ul><h3 id="7-configure-esp32-client"><span class="mr-2"><strong>7. Configure ESP32 Client</strong></span><a href="#7-configure-esp32-client" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>Modify the ESP32 code to connect to the secure MQTT endpoint. Since Traefik uses Let’s Encrypt, most clients trust the CA by default, but you may need to provide the Let’s Encrypt CA certificate for some MQTT libraries.</p><p>Example Arduino code (using <code class="language-plaintext highlighter-rouge">WiFiClientSecure</code> and <code class="language-plaintext highlighter-rouge">PubSubClient</code>):</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
</pre><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;WiFi.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;WiFiClientSecure.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;PubSubClient.h&gt;</span><span class="cp">
</span>
<span class="c1">// WiFi credentials</span>
<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">ssid</span> <span class="o">=</span> <span class="s">"YOUR_WIFI_SSID"</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">password</span> <span class="o">=</span> <span class="s">"YOUR_WIFI_PASSWORD"</span><span class="p">;</span>

<span class="c1">// MQTT broker settings</span>
<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">mqtt_server</span> <span class="o">=</span> <span class="s">"mqtt.example.com"</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">int</span> <span class="n">mqtt_port</span> <span class="o">=</span> <span class="mi">8883</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">mqtt_user</span> <span class="o">=</span> <span class="s">"YOUR_MQTT_USERNAME"</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">mqtt_password</span> <span class="o">=</span> <span class="s">"YOUR_MQTT_PASSWORD"</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">mqtt_client_id</span> <span class="o">=</span> <span class="s">"ESP32_Client"</span><span class="p">;</span>

<span class="c1">// Let’s Encrypt CA certificate (optional, if not trusted by default)</span>
<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">ca_cert</span> <span class="o">=</span> \
<span class="s">"-----BEGIN CERTIFICATE-----</span><span class="se">\n</span><span class="s">"</span> \
<span class="s">"MIIFazCCA1OgAwIBAgIRAIIQz7DSQONZRGPgu2OCiwAwDQYJKoZIhvcNAQELBQAw</span><span class="se">\n</span><span class="s">"</span> \
<span class="s">"... (ISRG Root X1 certificate, obtainable from https://letsencrypt.org/certs/) ...</span><span class="se">\n</span><span class="s">"</span> \
<span class="s">"-----END CERTIFICATE-----</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>

<span class="n">WiFiClientSecure</span> <span class="n">espClient</span><span class="p">;</span>
<span class="n">PubSubClient</span> <span class="nf">client</span><span class="p">(</span><span class="n">espClient</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">115200</span><span class="p">);</span>

  <span class="c1">// Connect to WiFi</span>
  <span class="n">WiFi</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">password</span><span class="p">);</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">WiFi</span><span class="p">.</span><span class="n">status</span><span class="p">()</span> <span class="o">!=</span> <span class="n">WL_CONNECTED</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"Connecting to WiFi..."</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"Connected to WiFi"</span><span class="p">);</span>

  <span class="c1">// Set CA certificate (optional if Let’s Encrypt is trusted)</span>
  <span class="n">espClient</span><span class="p">.</span><span class="n">setCACert</span><span class="p">(</span><span class="n">ca_cert</span><span class="p">);</span>

  <span class="c1">// Configure MQTT</span>
  <span class="n">client</span><span class="p">.</span><span class="n">setServer</span><span class="p">(</span><span class="n">mqtt_server</span><span class="p">,</span> <span class="n">mqtt_port</span><span class="p">);</span>
  <span class="n">client</span><span class="p">.</span><span class="n">setCallback</span><span class="p">(</span><span class="n">callback</span><span class="p">);</span>

  <span class="c1">// Connect to MQTT broker</span>
  <span class="n">reconnect</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">callback</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">topic</span><span class="p">,</span> <span class="n">byte</span><span class="o">*</span> <span class="n">payload</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">"Message received on topic: "</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">topic</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">"Payload: "</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span><span class="n">payload</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">reconnect</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">client</span><span class="p">.</span><span class="n">connected</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"Attempting MQTT connection..."</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="n">mqtt_client_id</span><span class="p">,</span> <span class="n">mqtt_user</span><span class="p">,</span> <span class="n">mqtt_password</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"Connected to MQTT broker"</span><span class="p">);</span>
      <span class="n">client</span><span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="s">"test/topic"</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">"Failed, rc="</span><span class="p">);</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">state</span><span class="p">());</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">" Retrying in 5 seconds..."</span><span class="p">);</span>
      <span class="n">delay</span><span class="p">(</span><span class="mi">5000</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">loop</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">client</span><span class="p">.</span><span class="n">connected</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">reconnect</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="n">client</span><span class="p">.</span><span class="n">loop</span><span class="p">();</span>
<span class="p">}</span>
</pre></table></code></div></div><ul><li>Use <code class="language-plaintext highlighter-rouge">mqtt.example.com</code> as the broker address and port 8883.<li>Include the Let’s Encrypt CA certificate if your MQTT library doesn’t trust it by default.</ul><h3 id="8-test-the-setup"><span class="mr-2"><strong>8. Test the Setup</strong></span><a href="#8-test-the-setup" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ul><li><strong>MQTT</strong>: Use an MQTT client (e.g., MQTT Explorer) to connect to <code class="language-plaintext highlighter-rouge">mqtt.example.com:8883</code> with TLS enabled, using the username and password from the <code class="language-plaintext highlighter-rouge">passwd</code> file.<li><strong>WebSocket</strong>: Connect to <code class="language-plaintext highlighter-rouge">wss://mqtt.example.com:443</code> using a WebSocket-capable MQTT client (e.g., HiveMQ WebSocket client).<li><strong>Command Line</strong>:<div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>mosquitto_sub <span class="nt">-h</span> mqtt.example.com <span class="nt">-p</span> 8883 <span class="nt">-t</span> <span class="s2">"test/topic"</span> <span class="nt">-u</span> &lt;username&gt; <span class="nt">-P</span> &lt;password&gt; <span class="nt">--tls-version</span> tlsv1.2
</pre></table></code></div></div><p>Note: Some clients (e.g., <code class="language-plaintext highlighter-rouge">mosquitto_sub</code>) may require the Let’s Encrypt CA certificate (<code class="language-plaintext highlighter-rouge">--cafile ca.crt</code>) if they don’t trust it by default.</p></ul><h3 id="9-verify-logs"><span class="mr-2"><strong>9. Verify Logs</strong></span><a href="#9-verify-logs" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ul><li>Check Traefik logs for certificate issuance and routing:<div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>docker logs traefik
</pre></table></code></div></div><li>Check Mosquitto logs for client connections:<div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>docker logs mosquitto
</pre></table></code></div></div></ul><hr /><h2 id="optional-mutual-tls-with-mosquitto"><span class="mr-2"><strong>Optional: Mutual TLS with Mosquitto</strong></span><a href="#optional-mutual-tls-with-mosquitto" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>If you need client certificate authentication (mutual TLS):</p><ol><li>Configure Mosquitto to require client certificates by adding to <code class="language-plaintext highlighter-rouge">mosquitto.conf</code>:<div class="language-conf highlighter-rouge"><div class="code-header"> <span data-label-text="Conf"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="n">listener</span> <span class="m">1883</span>
<span class="n">cafile</span> /<span class="n">mosquitto</span>/<span class="n">config</span>/<span class="n">certs</span>/<span class="n">ca</span>.<span class="n">crt</span>
<span class="n">certfile</span> /<span class="n">mosquitto</span>/<span class="n">config</span>/<span class="n">certs</span>/<span class="n">server</span>.<span class="n">crt</span>
<span class="n">keyfile</span> /<span class="n">mosquitto</span>/<span class="n">config</span>/<span class="n">certs</span>/<span class="n">server</span>.<span class="n">key</span>
<span class="n">require_certificate</span> <span class="n">true</span>
<span class="n">use_identity_as_username</span> <span class="n">true</span>
</pre></table></code></div></div><li>Mount self-signed certificates into the Mosquitto container: ```yaml volumes:<ul><li>./mosquitto/config/certs:/mosquitto/config/certs ```</ul><li>Generate client certificates and provide them to the ESP32 (as shown in the previous response).<li>Configure Traefik to pass through TLS traffic (<code class="language-plaintext highlighter-rouge">tls.passthrough=true</code>) to Mosquitto, as Traefik won’t terminate the client certificate authentication.</ol><p>This approach requires Mosquitto to handle TLS, reducing Traefik’s role to routing, and is more complex due to certificate management.<a href="https://gist.github.com/natcl/ed8253a34e7b87d879baabeba82cb846"></a></p><hr /><h2 id="troubleshooting"><span class="mr-2"><strong>Troubleshooting</strong></span><a href="#troubleshooting" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ul><li><strong>Certificate Errors</strong>:<ul><li>Ensure <code class="language-plaintext highlighter-rouge">mqtt.example.com</code> resolves to your server’s public IP.<li>Verify Let’s Encrypt certificate issuance in <code class="language-plaintext highlighter-rouge">traefik/acme.json</code>.<li>Use <code class="language-plaintext highlighter-rouge">openssl s_client -connect mqtt.example.com:8883</code> to inspect the presented certificate.</ul><li><strong>Connection Refused</strong>:<ul><li>Check that ports 80, 443, and 8883 are open in your firewall.<li>Ensure Mosquitto’s ports are not exposed directly (<code class="language-plaintext highlighter-rouge">expose</code> instead of <code class="language-plaintext highlighter-rouge">ports</code>).<li>Verify username/password in the <code class="language-plaintext highlighter-rouge">passwd</code> file.</ul><li><strong>SNI Issues</strong>:<ul><li>If clients don’t support SNI, ensure <code class="language-plaintext highlighter-rouge">HostSNI(</code>*<code class="language-plaintext highlighter-rouge">)</code> is used in Traefik’s TCP router.<a href="https://community.traefik.io/t/mosquitto-mqtt-and-tls-without-client-hostsni/21912"></a></ul><li><strong>WebSocket Issues</strong>:<ul><li>Confirm the WebSocket client uses <code class="language-plaintext highlighter-rouge">wss://</code> and port 443.<li>Check Traefik logs for WebSocket routing errors.<a href="https://medium.com/%40panda1100/mqtt-over-websocket-over-ssl-tls-behind-traefik-v2-6-with-lets-encrypt-cert-a88b19cb977"></a></ul><li><strong>Logs</strong>:<ul><li>Enable verbose logging in Mosquitto (<code class="language-plaintext highlighter-rouge">log_type all</code> in <code class="language-plaintext highlighter-rouge">mosquitto.conf</code>).<li>Use Traefik’s dashboard (add <code class="language-plaintext highlighter-rouge">--api.insecure=true</code> to <code class="language-plaintext highlighter-rouge">traefik.yml</code>) to inspect routing.</ul></ul><hr /><h2 id="best-practices"><span class="mr-2"><strong>Best Practices</strong></span><a href="#best-practices" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ul><li><strong>Use Let’s Encrypt for Production</strong>: Avoid self-signed certificates to simplify client configuration.<a href="https://medium.com/%40synoniem/running-mosquitto-mqtt-server-with-docker-traefik-and-lets-encrypt-a1f6cbb864cc"></a><li><strong>Secure Passwords</strong>: Use strong, unique passwords in Mosquitto’s <code class="language-plaintext highlighter-rouge">passwd</code> file.<a href="https://jurian.slui.mn/posts/smqttt-or-secure-mqtt-over-traefik/"></a><li><strong>Network Isolation</strong>: Place Traefik and Mosquitto in a dedicated Docker network (<code class="language-plaintext highlighter-rouge">mqtt</code>) to prevent direct access to Mosquitto.<a href="https://gist.github.com/gimiki/628e2ca10f026975f00f34e4d1f4ff23?permalink_comment_id=3463714"></a><li><strong>Monitor Certificates</strong>: Ensure Traefik renews Let’s Encrypt certificates automatically (stored in <code class="language-plaintext highlighter-rouge">acme.json</code>).<li><strong>Backup <code class="language-plaintext highlighter-rouge">acme.json</code></strong>: Protect the Let’s Encrypt certificate store to avoid rate limit issues.<li><strong>Update Regularly</strong>: Keep Traefik and Mosquitto images up to date (<code class="language-plaintext highlighter-rouge">latest</code> or specific versions).</ul><hr /><h2 id="example-sources"><span class="mr-2"><strong>Example Sources</strong></span><a href="#example-sources" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>This setup is inspired by community examples and best practices:</p><ul><li>A Docker Compose configuration for Mosquitto with Traefik and Let’s Encrypt: https://github.com/synoniem/mosquitto-traefik-letsencrypt<a href="https://gist.github.com/gimiki/628e2ca10f026975f00f34e4d1f4ff23?permalink_comment_id=3463714"></a><li>Traefik documentation on TCP routing: https://docs.traefik.io/routing/routers/#rule_1<li>Medium article on secure MQTT with Traefik: https://medium.com/himinds/mqtt-broker-with-secure-websocket-using-traefik-docker-compose-and-lets-encrypt-61441879f2f7<a href="https://medium.com/himinds/mqtt-broker-with-secure-websocket-using-traefik-docker-compose-and-lets-encrypt-2b8e32207555"></a></ul><hr /><h2 id="conclusion"><span class="mr-2"><strong>Conclusion</strong></span><a href="#conclusion" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Dockerizing Mosquitto with TLS through Traefik is not only possible but also a robust solution for securing MQTT communication. By leveraging Traefik’s TLS termination and Let’s Encrypt integration, you simplify certificate management and enhance scalability. The provided Docker Compose configuration supports both MQTT (port 8883) and WebSocket (port 443) with minimal Mosquitto configuration. For high-security use cases, mutual TLS can be added, though it requires Mosquitto to handle certificates directly.</p><p>If you need help with specific configurations, testing, or integrating with your ESP32, let me know!</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/docker/'>Docker</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/dockerize/" class="post-tag no-text-decoration" >dockerize</a> <a href="/tags/mosquitto/" class="post-tag no-text-decoration" >mosquitto</a> <a href="/tags/mqtt/" class="post-tag no-text-decoration" >mqtt</a> <a href="/tags/tarfeik/" class="post-tag no-text-decoration" >tarfeik</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Dokerize mosquitto throw traefik - JMC-memo&amp;url=https://gitjmc.github.io/posts/dockerize-traefik-mosquitto/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Dokerize mosquitto throw traefik - JMC-memo&amp;u=https://gitjmc.github.io/posts/dockerize-traefik-mosquitto/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://gitjmc.github.io/posts/dockerize-traefik-mosquitto/&amp;text=Dokerize mosquitto throw traefik - JMC-memo" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://gitjmc.github.io/posts/dockerize-traefik-mosquitto/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <a href="http://service.weibo.com/share/share.php?title=Dokerize mosquitto throw traefik - JMC-memo&amp;url=https://gitjmc.github.io/posts/dockerize-traefik-mosquitto/" data-toggle="tooltip" data-placement="top" title="Weibo" target="_blank" rel="noopener" aria-label="Weibo"> <i class="fa-fw fab fa-weibo"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/esp32/">ESP 32</a><li><a href="/posts/iot-project/">Iot Project with ESP 32</a><li><a href="/posts/secureFormQualtrics/">How to secure Form in Qualtrics</a><li><a href="/posts/mosquitto-tls/">Mosquitto with Docker Compose and Base Authentication & Let's Encrypt (DuckDNS)</a><li><a href="/posts/docker-install/">Install Docker on Deepin 20.x</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/security/">security</a> <a class="post-tag" href="/tags/tuto/">tuto</a> <a class="post-tag" href="/tags/angular/">angular</a> <a class="post-tag" href="/tags/dev/">dev</a> <a class="post-tag" href="/tags/access/">access</a> <a class="post-tag" href="/tags/nextcloud/">nextcloud</a> <a class="post-tag" href="/tags/real-time/">real-time</a> <a class="post-tag" href="/tags/wireguard/">wireguard</a> <a class="post-tag" href="/tags/api/">api</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/iot-tools/"><div class="card-body"> <em class="timeago small" data-ts="1740828900" > 2025-03-01 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>IoT Stuck</h3><div class="text-muted small"><p></p></div></div></a></div><div class="card"> <a href="/posts/dockerize-jekyll/"><div class="card-body"> <em class="timeago small" data-ts="1649025600" > 2022-04-03 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Dockerize Jekyll</h3><div class="text-muted small"><p> This post will guide you how to dockerize Jekyll. Prerequistes Docker installed; docker-compose.yaml version: &#39;3&#39; services: jekyll-serve: image: jekyll/jekyll:4.0 volumes: ...</p></div></div></a></div><div class="card"> <a href="/posts/dockerize-angular/"><div class="card-body"> <em class="timeago small" data-ts="1649041500" > 2022-04-03 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Dockerize an Angular dev environment</h3><div class="text-muted small"><p> This post will guide you how to create an angular dev environment in docker. Contexte Pour ne pas installer sur son poste node, angular etc … Aussi avoir la possibilt/ de travailler avec dif...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/secure-connection-between-esp32-mosquitto/" class="btn btn-outline-primary" prompt="Older"><p>Secure connection between ESP32 and a Mosquitto MQTT broker And how Certificate works</p></a> <a href="/posts/secureFormQualtrics/" class="btn btn-outline-primary" prompt="Newer"><p>How to secure Form in Qualtrics</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://twitter.com/username">Jerbi Mohamed Chamseddine</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/security/">security</a> <a class="post-tag" href="/tags/tuto/">tuto</a> <a class="post-tag" href="/tags/angular/">angular</a> <a class="post-tag" href="/tags/dev/">dev</a> <a class="post-tag" href="/tags/access/">access</a> <a class="post-tag" href="/tags/nextcloud/">nextcloud</a> <a class="post-tag" href="/tags/real-time/">real-time</a> <a class="post-tag" href="/tags/wireguard/">wireguard</a> <a class="post-tag" href="/tags/api/">api</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-REJ95ZFTQX"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-REJ95ZFTQX'); }); </script>
