<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Mosquitto with Docker Compose and Base Authentication &amp; Let’s Encrypt (DuckDNS)" /><meta property="og:locale" content="en" /><meta name="description" content="Base Authentication &amp; Let’s Encrypt (DuckDNS)" /><meta property="og:description" content="Base Authentication &amp; Let’s Encrypt (DuckDNS)" /><link rel="canonical" href="https://gitjmc.github.io/posts/mosquitto-tls/" /><meta property="og:url" content="https://gitjmc.github.io/posts/mosquitto-tls/" /><meta property="og:site_name" content="JMC-memo" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2025-04-01T07:35:00-04:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Mosquitto with Docker Compose and Base Authentication &amp; Let’s Encrypt (DuckDNS)" /><meta name="twitter:site" content="@twitter_username" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2025-04-27T09:02:34-04:00","datePublished":"2025-04-01T07:35:00-04:00","description":"Base Authentication &amp; Let’s Encrypt (DuckDNS)","headline":"Mosquitto with Docker Compose and Base Authentication &amp; Let’s Encrypt (DuckDNS)","mainEntityOfPage":{"@type":"WebPage","@id":"https://gitjmc.github.io/posts/mosquitto-tls/"},"url":"https://gitjmc.github.io/posts/mosquitto-tls/"}</script><title>Mosquitto with Docker Compose and Base Authentication & Let's Encrypt (DuckDNS) | JMC-memo</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="JMC-memo"><meta name="application-name" content="JMC-memo"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" https://gitjmc.github.io/assets/img/favicons/avatar.jpg " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">JMC-memo</a></div><div class="site-subtitle font-italic">À la demande de sisi</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/gitjmc" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/twitter_username" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['example','doamin.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Mosquitto with Docker Compose and Base Authentication & Let's Encrypt (DuckDNS)</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Mosquitto with Docker Compose and Base Authentication & Let's Encrypt (DuckDNS)</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/username">Jerbi Mohamed Chamseddine</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1743507300" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2025-04-01 </em> </span> <span> Updated <em class="timeago" data-ts="1745758954" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2025-04-27 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2341 words"> <em>13 min</em> read</span></div></div></div><div class="post-content"><h1 id="base-authentication--lets-encrypt-duckdns">Base Authentication &amp; Let’s Encrypt (DuckDNS)</h1><p>Here’s a comprehensive guide to set up Mosquitto with Docker Compose using base authentication and Let’s Encrypt with a DuckDNS domain on a clean droplet.</p><h2 id="prerequisites"><span class="mr-2">Prerequisites</span><a href="#prerequisites" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ul><li>A domain pointed to your droplet (via DuckDNS)<li>Docker and Docker Compose installed<li>Ports 80, 443, and 1883 open in your firewall</ul><h2 id="step-1-set-up-duckdns-if-not-already-done"><span class="mr-2">Step 1: Set Up DuckDNS (if not already done)</span><a href="#step-1-set-up-duckdns-if-not-already-done" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ol><li>Create a DuckDNS account and claim your subdomain<li>Install DuckDNS updater (optional for dynamic IP):<div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>docker run <span class="nt">-d</span> <span class="nt">--name</span> duckdns <span class="se">\</span>
  <span class="nt">-e</span> <span class="nv">PUID</span><span class="o">=</span>1000 <span class="se">\</span>
  <span class="nt">-e</span> <span class="nv">PGID</span><span class="o">=</span>1000 <span class="se">\</span>
  <span class="nt">-e</span> <span class="nv">TZ</span><span class="o">=</span>UTC <span class="se">\</span>
  <span class="nt">-e</span> <span class="nv">SUBDOMAINS</span><span class="o">=</span>yourdomain <span class="se">\</span>
  <span class="nt">-e</span> <span class="nv">TOKEN</span><span class="o">=</span>your-duckdns-token <span class="se">\</span>
  <span class="nt">-e</span> <span class="nv">LOG_FILE</span><span class="o">=</span><span class="nb">false</span> <span class="se">\</span>
  <span class="nt">--restart</span> unless-stopped <span class="se">\</span>
  linuxserver/duckdns
</pre></table></code></div></div></ol><h2 id="step-2-create-docker-compose-file"><span class="mr-2">Step 2: Create Docker Compose File</span><a href="#step-2-create-docker-compose-file" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Create a <code class="language-plaintext highlighter-rouge">docker-compose.yml</code> file with the following content:</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
</pre><td class="rouge-code"><pre><span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3.8'</span>

<span class="na">services</span><span class="pi">:</span>
  <span class="na">mosquitto</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">eclipse-mosquitto:2</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">mosquitto</span>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">unless-stopped</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">1883:1883"</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">9001:9001"</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">./mosquitto/config:/mosquitto/config</span>
      <span class="pi">-</span> <span class="s">./mosquitto/data:/mosquitto/data</span>
      <span class="pi">-</span> <span class="s">./mosquitto/log:/mosquitto/log</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">TZ=UTC</span>
    <span class="na">depends_on</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">nginx-proxy</span>

  <span class="na">nginx-proxy</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">nginxproxy/nginx-proxy</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">nginx-proxy</span>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">unless-stopped</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">80:80"</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">443:443"</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">./certs:/etc/nginx/certs</span>
      <span class="pi">-</span> <span class="s">./vhost.d:/etc/nginx/vhost.d</span>
      <span class="pi">-</span> <span class="s">/var/run/docker.sock:/tmp/docker.sock:ro</span>
      <span class="pi">-</span> <span class="s">./html:/usr/share/nginx/html</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">DEFAULT_HOST=yourdomain.duckdns.org</span>

  <span class="na">letsencrypt</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">nginxproxy/acme-companion</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">nginx-proxy-letsencrypt</span>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">unless-stopped</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">./certs:/etc/nginx/certs</span>
      <span class="pi">-</span> <span class="s">./acme.sh:/etc/acme.sh</span>
      <span class="pi">-</span> <span class="s">/var/run/docker.sock:/var/run/docker.sock:ro</span>
      <span class="pi">-</span> <span class="s">./vhost.d:/etc/nginx/vhost.d</span>
      <span class="pi">-</span> <span class="s">./html:/usr/share/nginx/html</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">DEFAULT_EMAIL=your@email.com</span>
      <span class="pi">-</span> <span class="s">NGINX_PROXY_CONTAINER=nginx-proxy</span>
</pre></table></code></div></div><h2 id="step-3-create-mosquitto-configuration"><span class="mr-2">Step 3: Create Mosquitto Configuration</span><a href="#step-3-create-mosquitto-configuration" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Create the directory structure and config file:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">mkdir</span> <span class="nt">-p</span> mosquitto/config mosquitto/data mosquitto/log
</pre></table></code></div></div><p>Create <code class="language-plaintext highlighter-rouge">mosquitto/config/mosquitto.conf</code>:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre>persistence true
persistence_location /mosquitto/data/
log_dest file /mosquitto/log/mosquitto.log

# Authentication
allow_anonymous false
password_file /mosquitto/config/passwd

# MQTT
listener 1883
protocol mqtt

# Websockets
listener 9001
protocol websockets
</pre></table></code></div></div><h2 id="step-4-set-up-authentication"><span class="mr-2">Step 4: Set Up Authentication</span><a href="#step-4-set-up-authentication" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ol><li>Create a password file (replace username/password):<div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>docker run <span class="nt">-it</span> <span class="nt">--rm</span> <span class="nt">-v</span> <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>/mosquitto/config:/mosquitto/config eclipse-mosquitto:2 mosquitto_passwd <span class="nt">-c</span> /mosquitto/config/passwd username
</pre></table></code></div></div><p>(You’ll be prompted to enter and confirm the password)</p><li>For additional users (without -c flag to avoid overwriting):<div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>docker run <span class="nt">-it</span> <span class="nt">--rm</span> <span class="nt">-v</span> <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>/mosquitto/config:/mosquitto/config eclipse-mosquitto:2 mosquitto_passwd /mosquitto/config/passwd anotheruser
</pre></table></code></div></div></ol><h2 id="step-5-set-up-environment"><span class="mr-2">Step 5: Set Up Environment</span><a href="#step-5-set-up-environment" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Create a <code class="language-plaintext highlighter-rouge">.env</code> file:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>VIRTUAL_HOST=yourdomain.duckdns.org
LETSENCRYPT_HOST=yourdomain.duckdns.org
LETSENCRYPT_EMAIL=your@email.com
</pre></table></code></div></div><h2 id="step-6-start-the-services"><span class="mr-2">Step 6: Start the Services</span><a href="#step-6-start-the-services" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>docker compose up <span class="nt">-d</span>
</pre></table></code></div></div><h2 id="step-7-verify-setup"><span class="mr-2">Step 7: Verify Setup</span><a href="#step-7-verify-setup" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ol><li>Check logs for errors:<div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>docker logs mosquitto
docker logs nginx-proxy
docker logs nginx-proxy-letsencrypt
</pre></table></code></div></div><li>Test MQTT connection:<div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>mosquitto_sub <span class="nt">-h</span> yourdomain.duckdns.org <span class="nt">-t</span> <span class="nb">test</span> <span class="nt">-u</span> username <span class="nt">-P</span> password
</pre></table></code></div></div><p>(In another terminal)</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>mosquitto_pub <span class="nt">-h</span> yourdomain.duckdns.org <span class="nt">-t</span> <span class="nb">test</span> <span class="nt">-m</span> <span class="s2">"hello"</span> <span class="nt">-u</span> username <span class="nt">-P</span> password
</pre></table></code></div></div></ol><h2 id="common-issues-and-solutions"><span class="mr-2">Common Issues and Solutions</span><a href="#common-issues-and-solutions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ol><li><strong>Certificate errors</strong>:<ul><li>Ensure your domain resolves correctly to the server IP<li>Check port 80 is open and accessible<li>Wait a few minutes for Let’s Encrypt to issue certificates</ul><li><strong>Authentication failures</strong>:<ul><li>Verify the password file exists and has correct permissions<li>Check the password file path in mosquitto.conf</ul><li><strong>Connection issues</strong>:<ul><li>Verify ports are open in firewall: <code class="language-plaintext highlighter-rouge">sudo ufw allow 80,443,1883/tcp</code><li>Check Mosquitto is listening: <code class="language-plaintext highlighter-rouge">netstat -tulnp | grep mosquitto</code></ul><li><strong>DuckDNS updates</strong>:<ul><li>If your IP changes frequently, ensure the DuckDNS updater is running</ul></ol><p>This setup provides a secure Mosquitto broker with:</p><ul><li>TLS encryption via Let’s Encrypt<li>Basic authentication<li>WebSockets support<li>Automatic certificate renewal<li>Reverse proxy for additional security</ul><hr /><h1 id="base-authentication--lets-encrypt-direct-setup">Base Authentication &amp; Let’s Encrypt (Direct Setup)</h1><p>Here’s a simplified setup that integrates Let’s Encrypt directly with Mosquitto without using Nginx as a reverse proxy.</p><h2 id="prerequisites-1"><span class="mr-2">Prerequisites</span><a href="#prerequisites-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ul><li>A domain pointed to your droplet (via DuckDNS)<li>Docker and Docker Compose installed<li>Ports 80 (temporary for certbot), 443, and 1883 open in your firewall</ul><h2 id="step-1-create-docker-compose-file"><span class="mr-2">Step 1: Create Docker Compose File</span><a href="#step-1-create-docker-compose-file" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Create a <code class="language-plaintext highlighter-rouge">docker-compose.yml</code> file with:</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre><td class="rouge-code"><pre><span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3.8'</span>

<span class="na">services</span><span class="pi">:</span>
  <span class="na">mosquitto</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">eclipse-mosquitto:2</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">mosquitto</span>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">unless-stopped</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">1883:1883"</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">8883:8883"</span>  <span class="c1"># SSL port</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">80:80"</span>      <span class="c1"># Temporary for certbot</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">9001:9001"</span>  <span class="c1"># WebSocket</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">./mosquitto/config:/mosquitto/config</span>
      <span class="pi">-</span> <span class="s">./mosquitto/data:/mosquitto/data</span>
      <span class="pi">-</span> <span class="s">./mosquitto/log:/mosquitto/log</span>
      <span class="pi">-</span> <span class="s">./letsencrypt:/etc/letsencrypt</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">TZ=UTC</span>
    <span class="na">command</span><span class="pi">:</span> <span class="s">/bin/sh -c "(if [ ! -f /etc/letsencrypt/live/yourdomain.duckdns.org/cert.pem ]; then sleep 30; fi) &amp;&amp; /usr/sbin/mosquitto -c /mosquitto/config/mosquitto.conf"</span>

  <span class="na">certbot</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">certbot/certbot</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">certbot</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">./letsencrypt:/etc/letsencrypt</span>
      <span class="pi">-</span> <span class="s">./mosquitto/config:/mosquitto/config</span>
    <span class="na">entrypoint</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/bin/sh</span><span class="nv"> </span><span class="s">-c"</span>
    <span class="na">command</span><span class="pi">:</span> <span class="pi">|</span>
      <span class="s">"</span>
      <span class="s">if [ ! -f /etc/letsencrypt/live/yourdomain.duckdns.org/cert.pem ]; then</span>
        <span class="s">certbot certonly --standalone --non-interactive --agree-tos --email your@email.com -d yourdomain.duckdns.org;</span>
        <span class="s">ln -sf /etc/letsencrypt/live/yourdomain.duckdns.org/cert.pem /mosquitto/config/server.crt;</span>
        <span class="s">ln -sf /etc/letsencrypt/live/yourdomain.duckdns.org/privkey.pem /mosquitto/config/server.key;</span>
      <span class="s">fi &amp;&amp;</span>
      <span class="s">while :; do</span>
        <span class="s">sleep 12h &amp; wait $${!};</span>
        <span class="s">certbot renew;</span>
      <span class="s">done</span>
      <span class="s">"</span>
    <span class="na">depends_on</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">mosquitto</span>
</pre></table></code></div></div><h2 id="step-2-create-mosquitto-configuration"><span class="mr-2">Step 2: Create Mosquitto Configuration</span><a href="#step-2-create-mosquitto-configuration" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Create the directory structure:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">mkdir</span> <span class="nt">-p</span> mosquitto/<span class="o">{</span>config,data,log<span class="o">}</span> letsencrypt
</pre></table></code></div></div><p>Create <code class="language-plaintext highlighter-rouge">mosquitto/config/mosquitto.conf</code>:</p><div class="language-conf highlighter-rouge"><div class="code-header"> <span data-label-text="Conf"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="n">persistence</span> <span class="n">true</span>
<span class="n">persistence_location</span> /<span class="n">mosquitto</span>/<span class="n">data</span>/
<span class="n">log_dest</span> <span class="n">file</span> /<span class="n">mosquitto</span>/<span class="n">log</span>/<span class="n">mosquitto</span>.<span class="n">log</span>

<span class="c"># Authentication
</span><span class="n">allow_anonymous</span> <span class="n">false</span>
<span class="n">password_file</span> /<span class="n">mosquitto</span>/<span class="n">config</span>/<span class="n">passwd</span>

<span class="c"># MQTT
</span><span class="n">listener</span> <span class="m">1883</span>
<span class="n">protocol</span> <span class="n">mqtt</span>

<span class="c"># MQTT over SSL
</span><span class="n">listener</span> <span class="m">8883</span>
<span class="n">protocol</span> <span class="n">mqtt</span>
<span class="n">certfile</span> /<span class="n">mosquitto</span>/<span class="n">config</span>/<span class="n">server</span>.<span class="n">crt</span>
<span class="n">keyfile</span> /<span class="n">mosquitto</span>/<span class="n">config</span>/<span class="n">server</span>.<span class="n">key</span>

<span class="c"># WebSockets
</span><span class="n">listener</span> <span class="m">9001</span>
<span class="n">protocol</span> <span class="n">websockets</span>
</pre></table></code></div></div><h2 id="step-3-set-up-authentication"><span class="mr-2">Step 3: Set Up Authentication</span><a href="#step-3-set-up-authentication" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Create password file (replace username/password):</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>docker run <span class="nt">-it</span> <span class="nt">--rm</span> <span class="nt">-v</span> <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>/mosquitto/config:/mosquitto/config eclipse-mosquitto:2 mosquitto_passwd <span class="nt">-c</span> /mosquitto/config/passwd username
</pre></table></code></div></div><h2 id="step-4-start-the-services"><span class="mr-2">Step 4: Start the Services</span><a href="#step-4-start-the-services" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>docker compose up <span class="nt">-d</span>
</pre></table></code></div></div><h2 id="step-5-verify-setup"><span class="mr-2">Step 5: Verify Setup</span><a href="#step-5-verify-setup" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ol><li>Check certificates were generated:<div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>docker <span class="nb">exec </span>mosquitto <span class="nb">ls</span> <span class="nt">-la</span> /mosquitto/config/
</pre></table></code></div></div><p>(Should see server.crt and server.key symlinks)</p><li>Test SSL connection:<div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>mosquitto_sub <span class="nt">-h</span> yourdomain.duckdns.org <span class="nt">-t</span> <span class="nb">test</span> <span class="nt">-p</span> 8883 <span class="nt">--capath</span> /etc/ssl/certs/ <span class="nt">-u</span> username <span class="nt">-P</span> password
</pre></table></code></div></div><p>(In another terminal)</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>mosquitto_pub <span class="nt">-h</span> yourdomain.duckdns.org <span class="nt">-t</span> <span class="nb">test</span> <span class="nt">-m</span> <span class="s2">"hello"</span> <span class="nt">-p</span> 8883 <span class="nt">--capath</span> /etc/ssl/certs/ <span class="nt">-u</span> username <span class="nt">-P</span> password
</pre></table></code></div></div></ol><h2 id="step-6-clean-up-temporary-port"><span class="mr-2">Step 6: Clean Up Temporary Port</span><a href="#step-6-clean-up-temporary-port" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>After certificates are generated (check with <code class="language-plaintext highlighter-rouge">docker logs certbot</code>), you can:</p><ol><li>Remove port 80 from mosquitto service in docker-compose.yml<li>Update the file and run:<div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>docker compose down <span class="o">&amp;&amp;</span> docker compose up <span class="nt">-d</span>
</pre></table></code></div></div></ol><h2 id="certificate-renewal"><span class="mr-2">Certificate Renewal</span><a href="#certificate-renewal" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>The certbot container will automatically:</p><ol><li>Check for certificates on startup<li>Renew certificates when needed (every 12 hours)<li>Update the symlinks Mosquitto uses</ol><h2 id="security-considerations"><span class="mr-2">Security Considerations</span><a href="#security-considerations" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ol><li>After setup, close port 80 if not needed:<div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>ufw deny 80/tcp
</pre></table></code></div></div><li>Consider adding additional security to your Mosquitto configuration:<div class="language-conf highlighter-rouge"><div class="code-header"> <span data-label-text="Conf"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="c"># Add to mosquitto.conf
</span><span class="n">require_certificate</span> <span class="n">false</span>
<span class="n">tls_version</span> <span class="n">tlsv1</span>.<span class="m">2</span>
</pre></table></code></div></div></ol><p>This direct approach is simpler than using Nginx as a reverse proxy while still providing:</p><ul><li>Automatic Let’s Encrypt certificate management<li>Secure MQTT over SSL (port 8883)<li>Basic authentication<li>WebSockets support<li>Automatic certificate renewal</ul><hr /><h1 id="base-authentication--from-chatgpt">Base authentication … From chatGpt</h1><p>To set up Mosquitto with Docker Compose, basic authentication, and Let’s Encrypt on a clean droplet using a DuckDNS domain, follow these optimized steps:</p><h2 id="1-install-docker--docker-compose"><span class="mr-2">1. Install Docker &amp; Docker Compose</span><a href="#1-install-docker--docker-compose" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Ensure your droplet has Docker and Docker Compose installed:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>apt update <span class="o">&amp;&amp;</span> <span class="nb">sudo </span>apt upgrade <span class="nt">-y</span>
<span class="nb">sudo </span>apt <span class="nb">install </span>docker.io <span class="nt">-y</span>
<span class="nb">sudo </span>systemctl <span class="nb">enable</span> <span class="nt">--now</span> docker
<span class="nb">sudo </span>usermod <span class="nt">-aG</span> docker <span class="nv">$USER</span>
</pre></table></code></div></div><p>Install Docker Compose:</p><p>sudo apt install docker-compose -y</p><h2 id="2-set-up-duckdns"><span class="mr-2">2. Set Up DuckDNS</span><a href="#2-set-up-duckdns" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Register a free subdomain on DuckDNS and get your token.</p><p>Create a DuckDNS update script:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nb">mkdir</span> ~/duckdns <span class="o">&amp;&amp;</span> <span class="nb">cd</span> ~/duckdns
nano update.sh
</pre></table></code></div></div><p>Add:</p><p>#!/bin/bash echo url=”https://www.duckdns.org/update?domains=YOUR_SUBDOMAIN&amp;token=YOUR_DUCKDNS_TOKEN&amp;ip=” | curl -k -o ~/duckdns/duck.log -K -</p><p>Save and exit.</p><p>Make it executable:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">chmod</span> +x update.sh
</pre></table></code></div></div><p>Run it manually to test:</p><p>./update.sh</p><p>Set up a cron job to update it every 5 minutes:</p><div class="table-wrapper"><table><tbody><tr><td>(crontab -l ; echo “*/5 * * * * ~/duckdns/update.sh &gt;/dev/null 2&gt;&amp;1”)<td>crontab -</table></div><h2 id="3-prepare-mosquitto-configuration"><span class="mr-2">3. Prepare Mosquitto Configuration</span><a href="#3-prepare-mosquitto-configuration" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Create a working directory:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nb">mkdir</span> <span class="nt">-p</span> ~/mosquitto/config ~/mosquitto/data ~/mosquitto/log
<span class="nb">cd</span> ~/mosquitto/config
nano mosquitto.conf
</pre></table></code></div></div><p>Paste this config:</p><div class="language-conf highlighter-rouge"><div class="code-header"> <span data-label-text="Conf"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="n">listener</span> <span class="m">1883</span>
<span class="n">allow_anonymous</span> <span class="n">false</span>
<span class="n">password_file</span> /<span class="n">mosquitto</span>/<span class="n">config</span>/<span class="n">passwords</span>

<span class="n">listener</span> <span class="m">8883</span>
<span class="n">certfile</span> /<span class="n">mosquitto</span>/<span class="n">config</span>/<span class="n">certs</span>/<span class="n">fullchain</span>.<span class="n">pem</span>
<span class="n">keyfile</span> /<span class="n">mosquitto</span>/<span class="n">config</span>/<span class="n">certs</span>/<span class="n">privkey</span>.<span class="n">pem</span>
</pre></table></code></div></div><p>Save and exit.</p><h2 id="4-create-authentication-file"><span class="mr-2">4. Create Authentication File</span><a href="#4-create-authentication-file" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>docker run –rm eclipse-mosquitto mosquitto_passwd -c /mosquitto/config/passwords YOUR_USERNAME</p><p>Enter a strong password.</p><h2 id="5-set-up-lets-encrypt-ssl-using-certbot"><span class="mr-2">5. Set Up Let’s Encrypt SSL (Using Certbot)</span><a href="#5-set-up-lets-encrypt-ssl-using-certbot" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Install Certbot:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>apt <span class="nb">install </span>certbot <span class="nt">-y</span>
</pre></table></code></div></div><p>Run Certbot:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>certbot certonly <span class="nt">--standalone</span> <span class="nt">--preferred-challenges</span> http <span class="nt">--agree-tos</span> <span class="nt">--email</span> YOUR_EMAIL <span class="nt">-d</span> YOUR_SUBDOMAIN.duckdns.org
</pre></table></code></div></div><p>Move certificates:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nb">mkdir</span> <span class="nt">-p</span> ~/mosquitto/config/certs
<span class="nb">sudo cp</span> /etc/letsencrypt/live/YOUR_SUBDOMAIN.duckdns.org/fullchain.pem ~/mosquitto/config/certs/
<span class="nb">sudo cp</span> /etc/letsencrypt/live/YOUR_SUBDOMAIN.duckdns.org/privkey.pem ~/mosquitto/config/certs/
</pre></table></code></div></div><h2 id="6-create-docker-compose-file"><span class="mr-2">6. Create Docker Compose File</span><a href="#6-create-docker-compose-file" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Go back to your home directory and create docker-compose.yml:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nb">cd</span> ~/mosquitto
nano docker-compose.yml
</pre></table></code></div></div><p>Paste:</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3'</span>
<span class="na">services</span><span class="pi">:</span>
  <span class="na">mosquitto</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">eclipse-mosquitto</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">mosquitto</span>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">always</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">./config:/mosquitto/config</span>
      <span class="pi">-</span> <span class="s">./data:/mosquitto/data</span>
      <span class="pi">-</span> <span class="s">./log:/mosquitto/log</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">1883:1883"</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">8883:8883"</span>
</pre></table></code></div></div><p>Save and exit.</p><h2 id="7-start-mosquitto"><span class="mr-2">7. Start Mosquitto</span><a href="#7-start-mosquitto" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Run:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>docker-compose up <span class="nt">-d</span>
</pre></table></code></div></div><h2 id="8-auto-renew-ssl"><span class="mr-2">8. Auto-Renew SSL</span><a href="#8-auto-renew-ssl" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Create a script:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>nano /etc/cron.daily/certbot-renew
</pre></table></code></div></div><p>Add:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="c">#!/bin/bash</span>
certbot renew <span class="nt">--quiet</span>
<span class="nb">cp</span> /etc/letsencrypt/live/YOUR_SUBDOMAIN.duckdns.org/fullchain.pem ~/mosquitto/config/certs/
<span class="nb">cp</span> /etc/letsencrypt/live/YOUR_SUBDOMAIN.duckdns.org/privkey.pem ~/mosquitto/config/certs/
docker restart mosquitto
</pre></table></code></div></div><p>Save and make it executable:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="c">#!/bin/bash</span>
<span class="nb">sudo chmod</span> +x /etc/cron.daily/certbot-renew
</pre></table></code></div></div><p>This setup ensures secure MQTT connections with authentication and automatic SSL renewal.</p><p>Are you getting specific errors? I can help debug.</p><hr /><h1 id="from-grok">From grok</h1><p>Setting up Mosquitto with Docker Compose, basic authentication, Let’s Encrypt certificates, and a DuckDNS domain on a clean DigitalOcean droplet can be a powerful way to create a secure MQTT broker. Below, I’ll guide you through a streamlined, optimal approach to achieve this. I’ll assume you’re using Ubuntu (common for DigitalOcean droplets) and aim to avoid common pitfalls that might be causing your errors. If you share specific errors you’re encountering, I can refine this further!</p><hr /><h3 id="prerequisites-2"><span class="mr-2">Prerequisites</span><a href="#prerequisites-2" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ol><li><strong>Clean Droplet</strong>: Ubuntu 22.04 (or similar) installed.<li><strong>Domain</strong>: A DuckDNS subdomain (e.g., <code class="language-plaintext highlighter-rouge">yourname.duckdns.org</code>).<li><strong>Docker &amp; Docker Compose</strong>: Installed on the droplet.<li><strong>Ports</strong>: Ensure ports 80, 443, and 8883 are open in your droplet’s firewall and DigitalOcean networking settings.</ol><hr /><h3 id="step-by-step-guide"><span class="mr-2">Step-by-Step Guide</span><a href="#step-by-step-guide" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><h4 id="1-install-docker-and-docker-compose"><span class="mr-2">1. Install Docker and Docker Compose</span><a href="#1-install-docker-and-docker-compose" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>Log in to your droplet via SSH and run the following commands to install Docker and Docker Compose:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>apt update <span class="o">&amp;&amp;</span> <span class="nb">sudo </span>apt upgrade <span class="nt">-y</span>
<span class="nb">sudo </span>apt <span class="nb">install</span> <span class="nt">-y</span> docker.io docker-compose
<span class="nb">sudo </span>systemctl start docker
<span class="nb">sudo </span>systemctl <span class="nb">enable </span>docker
<span class="nb">sudo </span>usermod <span class="nt">-aG</span> docker <span class="nv">$USER</span>  <span class="c"># Log out and back in after this</span>
</pre></table></code></div></div><p>Verify installation:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>docker <span class="nt">--version</span>
docker-compose <span class="nt">--version</span>
</pre></table></code></div></div><h4 id="2-set-up-duckdns-1"><span class="mr-2">2. Set Up DuckDNS</span><a href="#2-set-up-duckdns-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><ul><li>Go to <a href="https://www.duckdns.org/">DuckDNS.org</a>, log in, and create a subdomain (e.g., <code class="language-plaintext highlighter-rouge">yourname.duckdns.org</code>).<li>Note your DuckDNS token (you’ll need it later).<li>Update your DuckDNS domain to point to your droplet’s public IP. You can automate this with a script or Docker container, but for now, manually set it on the DuckDNS website.</ul><h4 id="3-create-project-directory"><span class="mr-2">3. Create Project Directory</span><a href="#3-create-project-directory" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>Create a directory to hold your Mosquitto setup:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">mkdir</span> ~/mosquitto <span class="o">&amp;&amp;</span> <span class="nb">cd</span> ~/mosquitto
</pre></table></code></div></div><h4 id="4-configure-docker-compose"><span class="mr-2">4. Configure Docker Compose</span><a href="#4-configure-docker-compose" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>Create a <code class="language-plaintext highlighter-rouge">docker-compose.yml</code> file with Mosquitto and a Certbot service for Let’s Encrypt certificates:</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3.8'</span>

<span class="na">services</span><span class="pi">:</span>
  <span class="na">mosquitto</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">eclipse-mosquitto:latest</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">mosquitto</span>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">unless-stopped</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">1883:1883"</span>  <span class="c1"># Unsecured MQTT (optional, for testing)</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">8883:8883"</span>  <span class="c1"># Secured MQTT</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">80:80"</span>      <span class="c1"># Temporary for Certbot HTTP challenge</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">./mosquitto.conf:/mosquitto/config/mosquitto.conf</span>
      <span class="pi">-</span> <span class="s">./passwd:/mosquitto/config/passwd</span>
      <span class="pi">-</span> <span class="s">./letsencrypt:/etc/letsencrypt</span>
    <span class="na">depends_on</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">certbot</span>

  <span class="na">certbot</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">certbot/certbot</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">certbot</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">./letsencrypt:/etc/letsencrypt</span>
    <span class="na">command</span><span class="pi">:</span> <span class="s">certonly --standalone -d yourname.duckdns.org --email your.email@example.com --agree-tos --non-interactive</span>
    <span class="na">depends_on</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">mosquitto</span>
</pre></table></code></div></div><p><strong>Notes</strong>:</p><ul><li>Replace <code class="language-plaintext highlighter-rouge">yourname.duckdns.org</code> with your DuckDNS subdomain.<li>Replace <code class="language-plaintext highlighter-rouge">your.email@example.com</code> with your email for certificate notifications.<li>Port 80 is exposed temporarily for Certbot’s HTTP-01 challenge. After certificates are obtained, you can remove it.</ul><h4 id="5-configure-mosquitto"><span class="mr-2">5. Configure Mosquitto</span><a href="#5-configure-mosquitto" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>Create a <code class="language-plaintext highlighter-rouge">mosquitto.conf</code> file in the <code class="language-plaintext highlighter-rouge">~/mosquitto</code> directory:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>nano mosquitto.conf
</pre></table></code></div></div><p>Add the following configuration:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre># General settings
persistence true
persistence_location /mosquitto/data/
log_dest file /mosquitto/log/mosquitto.log

# Unsecured listener (optional, for testing)
listener 1883
allow_anonymous true

# Secured listener with TLS
listener 8883
allow_anonymous false
password_file /mosquitto/config/passwd
cafile /etc/letsencrypt/live/yourname.duckdns.org/chain.pem
certfile /etc/letsencrypt/live/yourname.duckdns.org/fullchain.pem
keyfile /etc/letsencrypt/live/yourname.duckdns.org/privkey.pem
</pre></table></code></div></div><ul><li><strong>1883</strong>: Unsecured MQTT for local testing (optional; remove later for security).<li><strong>8883</strong>: Secured MQTT with TLS and authentication.<li>Replace <code class="language-plaintext highlighter-rouge">yourname.duckdns.org</code> with your DuckDNS domain.</ul><h4 id="6-set-up-authentication"><span class="mr-2">6. Set Up Authentication</span><a href="#6-set-up-authentication" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>Create a password file for Mosquitto:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nb">touch </span>passwd
docker run <span class="nt">--rm</span> <span class="nt">-it</span> <span class="nt">-v</span> <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>/passwd:/passwd eclipse-mosquitto mosquitto_passwd <span class="nt">-b</span> /passwd username password
</pre></table></code></div></div><ul><li>Replace <code class="language-plaintext highlighter-rouge">username</code> and <code class="language-plaintext highlighter-rouge">password</code> with your desired credentials.<li>This adds a hashed password to the <code class="language-plaintext highlighter-rouge">passwd</code> file.</ul><h4 id="7-open-firewall-ports"><span class="mr-2">7. Open Firewall Ports</span><a href="#7-open-firewall-ports" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>Ensure the necessary ports are open:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>ufw allow 80
<span class="nb">sudo </span>ufw allow 443
<span class="nb">sudo </span>ufw allow 8883
<span class="nb">sudo </span>ufw status
</pre></table></code></div></div><p>Also, configure DigitalOcean’s firewall (via the control panel) to allow these ports.</p><h4 id="8-start-docker-compose"><span class="mr-2">8. Start Docker Compose</span><a href="#8-start-docker-compose" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>Run the setup:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>docker-compose up <span class="nt">-d</span>
</pre></table></code></div></div><ul><li>Certbot will obtain the Let’s Encrypt certificates and store them in the <code class="language-plaintext highlighter-rouge">letsencrypt</code> directory.<li>Mosquitto will start with TLS enabled once certificates are available.</ul><h4 id="9-verify-mosquitto"><span class="mr-2">9. Verify Mosquitto</span><a href="#9-verify-mosquitto" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>Test the unsecured port (if enabled):</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>docker run <span class="nt">--rm</span> <span class="nt">-it</span> eclipse-mosquitto mosquitto_sub <span class="nt">-h</span> your_droplet_ip <span class="nt">-p</span> 1883 <span class="nt">-t</span> <span class="nb">test</span>/topic
</pre></table></code></div></div><p>In another terminal:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>docker run <span class="nt">--rm</span> <span class="nt">-it</span> eclipse-mosquitto mosquitto_pub <span class="nt">-h</span> your_droplet_ip <span class="nt">-p</span> 1883 <span class="nt">-t</span> <span class="nb">test</span>/topic <span class="nt">-m</span> <span class="s2">"Hello"</span>
</pre></table></code></div></div><p>Test the secured port:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>docker run <span class="nt">--rm</span> <span class="nt">-it</span> eclipse-mosquitto mosquitto_sub <span class="nt">-h</span> yourname.duckdns.org <span class="nt">-p</span> 8883 <span class="nt">-u</span> username <span class="nt">-P</span> password <span class="nt">--cafile</span> /etc/ssl/certs/ca-certificates.crt <span class="nt">-t</span> <span class="nb">test</span>/topic
</pre></table></code></div></div><ul><li>You may need to adjust the <code class="language-plaintext highlighter-rouge">--cafile</code> path depending on your client system’s CA store.</ul><h4 id="10-automate-certificate-renewal"><span class="mr-2">10. Automate Certificate Renewal</span><a href="#10-automate-certificate-renewal" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>Edit <code class="language-plaintext highlighter-rouge">docker-compose.yml</code> to remove the <code class="language-plaintext highlighter-rouge">80:80</code> port mapping from Mosquitto (after certificates are obtained). Then, set up a cron job for renewal:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>crontab <span class="nt">-e</span>
</pre></table></code></div></div><p>Add:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>0 0 * * * docker-compose -f /home/youruser/mosquitto/docker-compose.yml run --rm certbot renew --quiet &amp;&amp; docker-compose -f /home/youruser/mosquitto/docker-compose.yml restart mosquitto
</pre></table></code></div></div><ul><li>Replace <code class="language-plaintext highlighter-rouge">/home/youruser/mosquitto</code> with your project path.</ul><h4 id="11-secure-the-setup"><span class="mr-2">11. Secure the Setup</span><a href="#11-secure-the-setup" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><ul><li>Remove the <code class="language-plaintext highlighter-rouge">listener 1883</code> section from <code class="language-plaintext highlighter-rouge">mosquitto.conf</code> if you don’t need unsecured access.<li>Restart the service:<div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>docker-compose down <span class="o">&amp;&amp;</span> docker-compose up <span class="nt">-d</span>
</pre></table></code></div></div></ul><hr /><h3 id="troubleshooting-common-errors"><span class="mr-2">Troubleshooting Common Errors</span><a href="#troubleshooting-common-errors" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ul><li><strong>“Connection refused”</strong>: Check if ports are open (<code class="language-plaintext highlighter-rouge">ufw</code> and DigitalOcean firewall), certificates are in place, and the domain resolves to your droplet’s IP.<li><strong>“TLS error”</strong>: Ensure the certificate paths in <code class="language-plaintext highlighter-rouge">mosquitto.conf</code> match the files in <code class="language-plaintext highlighter-rouge">./letsencrypt/live/yourname.duckdns.org/</code>.<li><strong>Certbot fails</strong>: Verify port 80 is accessible and the domain points to your droplet’s IP.</ul><hr /><h3 id="why-this-approach"><span class="mr-2">Why This Approach?</span><a href="#why-this-approach" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ul><li><strong>Docker Compose</strong>: Simplifies managing Mosquitto and Certbot together.<li><strong>Basic Authentication</strong>: Adds a security layer beyond TLS.<li><strong>Let’s Encrypt</strong>: Provides free, trusted certificates.<li><strong>DuckDNS</strong>: Free dynamic DNS that integrates well with home servers or droplets.<li><strong>Minimal Overhead</strong>: No reverse proxy (e.g., Nginx/Traefik) unless needed for additional services.</ul><p>Let me know your specific errors, and I’ll tailor this further!</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/dev/'>DEV</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/cli/" class="post-tag no-text-decoration" >cli</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Mosquitto with Docker Compose and Base Authentication &amp; Let&#39;s Encrypt (DuckDNS) - JMC-memo&amp;url=https://gitjmc.github.io/posts/mosquitto-tls/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Mosquitto with Docker Compose and Base Authentication &amp; Let&#39;s Encrypt (DuckDNS) - JMC-memo&amp;u=https://gitjmc.github.io/posts/mosquitto-tls/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://gitjmc.github.io/posts/mosquitto-tls/&amp;text=Mosquitto with Docker Compose and Base Authentication &amp; Let&#39;s Encrypt (DuckDNS) - JMC-memo" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://gitjmc.github.io/posts/mosquitto-tls/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <a href="http://service.weibo.com/share/share.php?title=Mosquitto with Docker Compose and Base Authentication &amp; Let&#39;s Encrypt (DuckDNS) - JMC-memo&amp;url=https://gitjmc.github.io/posts/mosquitto-tls/" data-toggle="tooltip" data-placement="top" title="Weibo" target="_blank" rel="noopener" aria-label="Weibo"> <i class="fa-fw fab fa-weibo"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/secureFormQualtrics/">How to secure Form in Qualtrics</a><li><a href="/posts/mosquitto-tls/">Mosquitto with Docker Compose and Base Authentication & Let's Encrypt (DuckDNS)</a><li><a href="/posts/common-cli/">Common CLI on linux</a><li><a href="/posts/docker-install/">Install Docker on Deepin 20.x</a><li><a href="/posts/docker-install-ubuntu/">Install Docker on ubuntu and Deepin</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/security/">security</a> <a class="post-tag" href="/tags/tuto/">tuto</a> <a class="post-tag" href="/tags/angular/">angular</a> <a class="post-tag" href="/tags/dev/">dev</a> <a class="post-tag" href="/tags/access/">access</a> <a class="post-tag" href="/tags/nextcloud/">nextcloud</a> <a class="post-tag" href="/tags/real-time/">real-time</a> <a class="post-tag" href="/tags/wireguard/">wireguard</a> <a class="post-tag" href="/tags/api/">api</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/common-commands/"><div class="card-body"> <em class="timeago small" data-ts="1646529840" > 2022-03-05 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Common Commands</h3><div class="text-muted small"><p> C’est la liste de commandes qui pourront me servir (pour ne pas les oublier) \o/ Liste des commandes pwd Print working directory $ pwd /home/jmc/dev/tempo/jekyll/gitjmc.github.io cp Copy file...</p></div></div></a></div><div class="card"> <a href="/posts/common-cli/"><div class="card-body"> <em class="timeago small" data-ts="1741520100" > 2025-03-09 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Common CLI on linux</h3><div class="text-muted small"><p> Create non-root user connecting to remote host with the same user on local machine Try root adduser jmc usermod -aG sudo jmc sudo su jmc whoami cd ~ mkdir .ssh chmod 700 .ssh touch .ssh/a...</p></div></div></a></div><div class="card"> <a href="/posts/docker-usefull-commands/"><div class="card-body"> <em class="timeago small" data-ts="1738935300" > 2025-02-07 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>The most useful Docker commands</h3><div class="text-muted small"><p> Here’s a comprehensive list of the most useful Docker commands for managing containers, images, networks, and volumes. These commands are essential for working with Docker in development, testing, ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/access-local-services-securel-with-wireguard/" class="btn btn-outline-primary" prompt="Older"><p>Access local services securel with Wireguard</p></a> <a href="/posts/homeServer/" class="btn btn-outline-primary" prompt="Newer"><p>Set up and configure home server</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://twitter.com/username">Jerbi Mohamed Chamseddine</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/security/">security</a> <a class="post-tag" href="/tags/tuto/">tuto</a> <a class="post-tag" href="/tags/angular/">angular</a> <a class="post-tag" href="/tags/dev/">dev</a> <a class="post-tag" href="/tags/access/">access</a> <a class="post-tag" href="/tags/nextcloud/">nextcloud</a> <a class="post-tag" href="/tags/real-time/">real-time</a> <a class="post-tag" href="/tags/wireguard/">wireguard</a> <a class="post-tag" href="/tags/api/">api</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-REJ95ZFTQX"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-REJ95ZFTQX'); }); </script>
